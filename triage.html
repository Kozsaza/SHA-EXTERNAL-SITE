<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHA | Secure Triage</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f4f4f9; color: #333; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        button { width: 100%; padding: 1rem; margin: 0.5rem 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .primary { background: #000; color: #fff; }
        .secondary { background: #e0e0e0; color: #333; }
        #status { color: #666; margin-top: 1rem; font-size: 0.9rem; }
        video { width: 100%; border-radius: 10px; background: #000; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card" id="gatekeeper-ui">
        <h2>Verifying Session...</h2>
        <p>Please wait while we secure your bridge.</p>
    </div>

    <div class="card" id="choice-ui" style="display:none;">
        <h2>Scalp Triage</h2>
        <p>Your privacy is protected. No images are saved to this device.</p>
        <button class="primary" onclick="startSelfCapture()">I'll take the photos myself</button>
        <button class="secondary" onclick="alert('HP Assist Mode coming soon')">Help me take photos</button>
    </div>

    <div class="card" id="camera-ui" style="display:none;">
        <h3>Gallery Guard Active</h3>
        <video id="viewfinder" autoplay playsinline></video>
        <canvas id="photo-buffer" style="display:none;"></canvas>
        <button class="primary" onclick="takePhoto()">Capture Image</button>
        <button class="secondary" onclick="stopCamera()">Cancel</button>
    </div>

    <p id="status"></p>

    <script>
        const workerUrl = "https://sha-lsr-engine.kozsaza.workers.dev";
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('s');
        let stream = null;

        // 1. SESSION VALIDATION ON LOAD
        async function validate() {
            if (!sessionId) {
                document.getElementById('status').innerText = "No session found. Please scan QR code.";
                return;
            }
            try {
                const res = await fetch(`${workerUrl}/validate-session?s=${sessionId}`);
                const data = await res.json();
                if (data.valid) {
                    document.getElementById('gatekeeper-ui').style.display = 'none';
                    document.getElementById('choice-ui').style.display = 'block';
                } else {
                    window.location.href = "index.html?error=invalid_session";
                }
            } catch (e) {
                document.getElementById('status').innerText = "Connection error. Retrying...";
            }
        }

        // 2. CAMERA LOGIC
        async function startSelfCapture() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: false 
                });
                document.getElementById('viewfinder').srcObject = stream;
                document.getElementById('choice-ui').style.display = 'none';
                document.getElementById('camera-ui').style.display = 'block';
            } catch (err) {
                alert("Camera access denied. Please check site permissions.");
            }
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('camera-ui').style.display = 'none';
            document.getElementById('choice-ui').style.display = 'block';
        }

        // 3. CAPTURE AND RELAY
        async function takePhoto() {
            const video = document.getElementById('viewfinder');
            const canvas = document.getElementById('photo-buffer');
            const context = canvas.getContext('2
