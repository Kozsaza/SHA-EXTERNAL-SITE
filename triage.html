<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHA | Secure Triage</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f4f4f9; }
        .card { background: white; padding: 2rem; border-radius: 15px; shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        button { width: 100%; padding: 1rem; margin: 0.5rem 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .primary { background: #000; color: #fff; }
        .secondary { background: #e0e0e0; color: #333; }
        #status { color: red; margin-top: 1rem; }
    </style>
</head>
<body>

    <div class="card" id="gatekeeper-ui">
        <h2>Verifying Session...</h2>
        <p>Please wait while we secure your bridge.</p>
    </div>

    <div class="card" id="choice-ui" style="display:none;">
        <h2>Scalp Triage</h2>
        <p>Your privacy is protected. No images are saved to your phone.</p>
        <button class="primary" onclick="startSelfCapture()">I'll take the photos myself</button>
        <button class="secondary" onclick="requestHPAssist()">Help me take photos</button>
    </div>

    <div class="card" id="tether-ui" style="display:none;">
        <h3>Professional Assistance</h3>
        <p>Give this code to your Hair Professional:</p>
        <h1 id="tether-code">----</h1>
        <p>Stay on this page. Your photos will appear here for review once they are captured.</p>
    </div>

    <p id="status"></p>

    <script>
        const workerUrl = "https://sha-lsr-engine.kozsaza.workers.dev";
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('s');

        // 1. VALIDATE SESSION ON LOAD
        async function validate() {
            if (!sessionId) {
                document.getElementById('status').innerText = "No session found. Please scan QR code.";
                return;
            }

            try {
                const res = await fetch(`${workerUrl}/validate-session?s=${sessionId}`);
                const data = await res.json();

                if (data.valid) {
                    document.getElementById('gatekeeper-ui').style.display = 'none';
                    document.getElementById('choice-ui').style.display = 'block';
                } else {
                    window.location.href = "index.html?error=invalid_session";
                }
            } catch (e) {
                document.getElementById('status').innerText = "Connection error. Try again.";
            }
        }

        function startSelfCapture() {
            alert("Gallery Guard Camera Initializing...");
            // We will add the camera logic in the next step
        }

        function requestHPAssist() {
            // Generate a random 4-digit code for the HP
            const code = Math.floor(1000 + Math.random() * 9000);
            document.getElementById('choice-ui').style.display = 'none';
            document.getElementById('tether-ui').style.display = 'block';
            document.getElementById('tether-code').innerText = code;
        }

        window.onload = validate;
    </script>
</body>
</html>
