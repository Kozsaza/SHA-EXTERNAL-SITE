<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHA | Secure Triage</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f4f4f9; color: #333; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        button { width: 100%; padding: 1rem; margin: 0.5rem 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .primary { background: #000; color: #fff; }
        .secondary { background: #e0e0e0; color: #333; }
        #status-msg { color: #666; margin-top: 1rem; font-size: 0.9rem; }
        video { width: 100%; border-radius: 10px; background: #000; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card" id="gatekeeper-ui">
        <h2 id="gatekeeper-title">Verifying Session...</h2>
        <p id="gatekeeper-text">Please wait while we secure your bridge.</p>
    </div>

    <div class="card" id="choice-ui" style="display:none;">
        <h2>Scalp Triage</h2>
        <p>No images are saved to your device gallery.</p>
        <button class="primary" onclick="startSelfCapture()">I'll take the photos myself</button>
        <button class="secondary" onclick="alert('Professional Assist Mode coming soon')">Help me take photos</button>
    </div>

    <div class="card" id="camera-ui" style="display:none;">
        <h3>Gallery Guard Active</h3>
        <video id="viewfinder" autoplay playsinline></video>
        <canvas id="photo-buffer" style="display:none;"></canvas>
        <button class="primary" onclick="takePhoto()">Capture Image</button>
        <button class="secondary" onclick="stopCamera()">Cancel</button>
    </div>

    <p id="status-msg"></p>

    <script>
        // CONFIG
        const workerUrl = "https://sha-lsr-engine.kozsaza.workers.dev";
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('s');
        let stream = null;

        // 1. INITIAL VALIDATION
        async function validate() {
            console.log("Validation started for session:", sessionId);
            if (!sessionId) {
                document.getElementById('status-msg').innerText = "Error: No Session ID found.";
                return;
            }

            try {
                const res = await fetch(`${workerUrl}/validate-session?s=${sessionId}`);
                const data = await res.json();

                if (data.valid) {
                    document.getElementById('gatekeeper-ui').style.display = 'none';
                    document.getElementById('choice-ui').style.display = 'block';
                } else {
                    document.getElementById('gatekeeper-title').innerText = "Session Invalid";
                    document.getElementById('gatekeeper-text').innerText = "This link may have expired.";
                }
            } catch (e) {
                console.error("Fetch error:", e);
                document.getElementById('status-msg').innerText = "Connection error. Worker may be offline.";
            }
        }

        // 2. CAMERA CONTROLS
        async function startSelfCapture() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio:
